-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.activity_logs (
  id character varying NOT NULL DEFAULT gen_random_uuid(),
  type text NOT NULL,
  action text NOT NULL,
  message text NOT NULL,
  user_id character varying,
  task_id character varying,
  container_id character varying,
  scan_event_id character varying,
  location jsonb,
  details text,
  metadata jsonb,
  timestamp timestamp without time zone NOT NULL DEFAULT now(),
  created_at timestamp without time zone NOT NULL DEFAULT now(),
  CONSTRAINT activity_logs_pkey PRIMARY KEY (id),
  CONSTRAINT activity_logs_user_id_users_id_fk FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT activity_logs_task_id_tasks_id_fk FOREIGN KEY (task_id) REFERENCES public.tasks(id),
  CONSTRAINT activity_logs_scan_event_id_scan_events_id_fk FOREIGN KEY (scan_event_id) REFERENCES public.scan_events(id)
);
CREATE TABLE public.boxes (
  id character varying NOT NULL DEFAULT gen_random_uuid(),
  stand_id character varying,
  qr_code text NOT NULL UNIQUE,
  serial text NOT NULL UNIQUE,
  status text NOT NULL DEFAULT 'AT_STAND'::text,
  current_task_id character varying,
  last_seen_at timestamp without time zone,
  notes text,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp without time zone NOT NULL DEFAULT now(),
  updated_at timestamp without time zone NOT NULL DEFAULT now(),
  CONSTRAINT boxes_pkey PRIMARY KEY (id),
  CONSTRAINT boxes_stand_id_stands_id_fk FOREIGN KEY (stand_id) REFERENCES public.stands(id)
);
CREATE TABLE public.customer_containers (
  id character varying NOT NULL,
  customer_id character varying,
  customer_name text NOT NULL,
  location text NOT NULL,
  latitude real,
  longitude real,
  qr_code text NOT NULL UNIQUE,
  material_type text NOT NULL,
  content_description text,
  status text NOT NULL DEFAULT 'AT_CUSTOMER'::text,
  last_emptied timestamp without time zone,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp without time zone NOT NULL DEFAULT now(),
  updated_at timestamp without time zone NOT NULL DEFAULT now(),
  CONSTRAINT customer_containers_pkey PRIMARY KEY (id),
  CONSTRAINT customer_containers_customer_id_customers_id_fk FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customers (
  id character varying NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  address text,
  contact_name text,
  contact_phone text,
  contact_email text,
  notes text,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp without time zone NOT NULL DEFAULT now(),
  updated_at timestamp without time zone NOT NULL DEFAULT now(),
  CONSTRAINT customers_pkey PRIMARY KEY (id)
);
CREATE TABLE public.departments (
  id character varying NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  code text NOT NULL UNIQUE,
  description text,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp without time zone NOT NULL DEFAULT now(),
  updated_at timestamp without time zone NOT NULL DEFAULT now(),
  CONSTRAINT departments_pkey PRIMARY KEY (id)
);
CREATE TABLE public.fill_history (
  id character varying NOT NULL DEFAULT gen_random_uuid(),
  warehouse_container_id character varying NOT NULL,
  amount_added real NOT NULL,
  quantity_unit text NOT NULL DEFAULT 'kg'::text,
  task_id character varying,
  recorded_by_user_id character varying,
  created_at timestamp without time zone NOT NULL DEFAULT now(),
  CONSTRAINT fill_history_pkey PRIMARY KEY (id),
  CONSTRAINT fill_history_warehouse_container_id_warehouse_containers_id_fk FOREIGN KEY (warehouse_container_id) REFERENCES public.warehouse_containers(id),
  CONSTRAINT fill_history_task_id_tasks_id_fk FOREIGN KEY (task_id) REFERENCES public.tasks(id),
  CONSTRAINT fill_history_recorded_by_user_id_users_id_fk FOREIGN KEY (recorded_by_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.halls (
  id character varying NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  code text NOT NULL UNIQUE,
  description text,
  location_meta jsonb,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp without time zone NOT NULL DEFAULT now(),
  updated_at timestamp without time zone NOT NULL DEFAULT now(),
  CONSTRAINT halls_pkey PRIMARY KEY (id)
);
CREATE TABLE public.materials (
  id character varying NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  code text NOT NULL UNIQUE,
  description text,
  hazard_class text,
  disposal_stream text,
  density_hint real,
  default_unit text NOT NULL DEFAULT 'kg'::text,
  qr_code text UNIQUE,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp without time zone NOT NULL DEFAULT now(),
  updated_at timestamp without time zone NOT NULL DEFAULT now(),
  CONSTRAINT materials_pkey PRIMARY KEY (id)
);
CREATE TABLE public.scan_events (
  id character varying NOT NULL DEFAULT gen_random_uuid(),
  container_id character varying NOT NULL,
  container_type text NOT NULL,
  task_id character varying,
  scanned_by_user_id character varying NOT NULL,
  scanned_at timestamp without time zone NOT NULL DEFAULT now(),
  scan_context text NOT NULL,
  location_type text NOT NULL,
  location_details text,
  geo_location jsonb,
  scan_result text NOT NULL DEFAULT 'SUCCESS'::text,
  result_message text,
  extra_data jsonb,
  created_at timestamp without time zone NOT NULL DEFAULT now(),
  CONSTRAINT scan_events_pkey PRIMARY KEY (id),
  CONSTRAINT scan_events_task_id_tasks_id_fk FOREIGN KEY (task_id) REFERENCES public.tasks(id),
  CONSTRAINT scan_events_scanned_by_user_id_users_id_fk FOREIGN KEY (scanned_by_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.stands (
  id character varying NOT NULL DEFAULT gen_random_uuid(),
  station_id character varying NOT NULL,
  identifier text NOT NULL,
  material_id character varying,
  qr_code text NOT NULL UNIQUE,
  sequence integer,
  position_meta jsonb,
  daily_full boolean NOT NULL DEFAULT false,
  last_daily_task_generated_at timestamp without time zone,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp without time zone NOT NULL DEFAULT now(),
  updated_at timestamp without time zone NOT NULL DEFAULT now(),
  daily_task_time_local text,
  CONSTRAINT stands_pkey PRIMARY KEY (id),
  CONSTRAINT stands_station_id_stations_id_fk FOREIGN KEY (station_id) REFERENCES public.stations(id),
  CONSTRAINT stands_material_id_materials_id_fk FOREIGN KEY (material_id) REFERENCES public.materials(id)
);
CREATE TABLE public.stations (
  id character varying NOT NULL DEFAULT gen_random_uuid(),
  hall_id character varying NOT NULL,
  name text NOT NULL,
  code text NOT NULL,
  sequence integer,
  location_meta jsonb,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp without time zone NOT NULL DEFAULT now(),
  updated_at timestamp without time zone NOT NULL DEFAULT now(),
  CONSTRAINT stations_pkey PRIMARY KEY (id),
  CONSTRAINT stations_hall_id_halls_id_fk FOREIGN KEY (hall_id) REFERENCES public.halls(id)
);
CREATE TABLE public.task_events (
  id character varying NOT NULL DEFAULT gen_random_uuid(),
  task_id character varying NOT NULL,
  actor_user_id character varying,
  action text NOT NULL,
  entity_type text,
  entity_id character varying,
  before_data jsonb,
  after_data jsonb,
  timestamp timestamp without time zone NOT NULL DEFAULT now(),
  actor_role text,
  actor_department_id character varying,
  meta_json jsonb,
  CONSTRAINT task_events_pkey PRIMARY KEY (id),
  CONSTRAINT task_events_task_id_tasks_id_fk FOREIGN KEY (task_id) REFERENCES public.tasks(id),
  CONSTRAINT task_events_actor_user_id_users_id_fk FOREIGN KEY (actor_user_id) REFERENCES public.users(id),
  CONSTRAINT task_events_actor_department_id_departments_id_fk FOREIGN KEY (actor_department_id) REFERENCES public.departments(id)
);
CREATE TABLE public.task_schedules (
  id character varying NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  is_active boolean NOT NULL DEFAULT true,
  stand_id character varying NOT NULL,
  station_id character varying,
  rule_type text NOT NULL,
  time_local text NOT NULL,
  weekdays ARRAY,
  every_n_days integer,
  start_date timestamp without time zone,
  timezone text NOT NULL DEFAULT 'Europe/Berlin'::text,
  create_days_ahead integer NOT NULL DEFAULT 7,
  created_by_id character varying,
  created_at timestamp without time zone NOT NULL DEFAULT now(),
  updated_at timestamp without time zone NOT NULL DEFAULT now(),
  CONSTRAINT task_schedules_pkey PRIMARY KEY (id),
  CONSTRAINT task_schedules_stand_id_stands_id_fk FOREIGN KEY (stand_id) REFERENCES public.stands(id),
  CONSTRAINT task_schedules_station_id_stations_id_fk FOREIGN KEY (station_id) REFERENCES public.stations(id),
  CONSTRAINT task_schedules_created_by_id_users_id_fk FOREIGN KEY (created_by_id) REFERENCES public.users(id)
);
CREATE TABLE public.tasks (
  id character varying NOT NULL DEFAULT gen_random_uuid(),
  title text,
  description text,
  container_id character varying NOT NULL,
  delivery_container_id character varying,
  created_by character varying,
  assigned_to character varying,
  scheduled_time timestamp without time zone,
  planned_quantity real,
  planned_quantity_unit text DEFAULT 'kg'::text,
  priority text NOT NULL DEFAULT 'normal'::text,
  material_type text,
  status text NOT NULL DEFAULT 'OFFEN'::text,
  created_at timestamp without time zone NOT NULL DEFAULT now(),
  assigned_at timestamp without time zone,
  accepted_at timestamp without time zone,
  picked_up_at timestamp without time zone,
  in_transit_at timestamp without time zone,
  delivered_at timestamp without time zone,
  completed_at timestamp without time zone,
  cancelled_at timestamp without time zone,
  pickup_timestamp timestamp without time zone,
  pickup_location jsonb,
  delivery_timestamp timestamp without time zone,
  actual_quantity real,
  actual_quantity_unit text DEFAULT 'kg'::text,
  notes text,
  cancellation_reason text,
  estimated_amount real,
  updated_at timestamp without time zone NOT NULL DEFAULT now(),
  claimed_by_user_id character varying,
  claimed_at timestamp without time zone,
  handover_at timestamp without time zone,
  measured_weight real,
  box_id character varying,
  stand_id character varying,
  target_warehouse_container_id character varying,
  dropped_off_at timestamp without time zone,
  taken_over_at timestamp without time zone,
  weighed_at timestamp without time zone,
  disposed_at timestamp without time zone,
  weight_kg real,
  weighed_by_user_id character varying,
  task_type text NOT NULL DEFAULT 'LEGACY'::text,
  scheduled_for timestamp without time zone,
  dedup_key text UNIQUE,
  source text NOT NULL DEFAULT 'LEGACY'::text,
  schedule_id character varying,
  CONSTRAINT tasks_pkey PRIMARY KEY (id),
  CONSTRAINT tasks_container_id_customer_containers_id_fk FOREIGN KEY (container_id) REFERENCES public.customer_containers(id),
  CONSTRAINT tasks_delivery_container_id_warehouse_containers_id_fk FOREIGN KEY (delivery_container_id) REFERENCES public.warehouse_containers(id),
  CONSTRAINT tasks_created_by_users_id_fk FOREIGN KEY (created_by) REFERENCES public.users(id),
  CONSTRAINT tasks_assigned_to_users_id_fk FOREIGN KEY (assigned_to) REFERENCES public.users(id),
  CONSTRAINT tasks_claimed_by_user_id_users_id_fk FOREIGN KEY (claimed_by_user_id) REFERENCES public.users(id),
  CONSTRAINT tasks_box_id_boxes_id_fk FOREIGN KEY (box_id) REFERENCES public.boxes(id),
  CONSTRAINT tasks_stand_id_stands_id_fk FOREIGN KEY (stand_id) REFERENCES public.stands(id),
  CONSTRAINT tasks_target_warehouse_container_id_warehouse_containers_id_fk FOREIGN KEY (target_warehouse_container_id) REFERENCES public.warehouse_containers(id),
  CONSTRAINT tasks_weighed_by_user_id_users_id_fk FOREIGN KEY (weighed_by_user_id) REFERENCES public.users(id),
  CONSTRAINT tasks_schedule_id_task_schedules_id_fk FOREIGN KEY (schedule_id) REFERENCES public.task_schedules(id)
);
CREATE TABLE public.users (
  id character varying NOT NULL DEFAULT gen_random_uuid(),
  email text NOT NULL UNIQUE,
  password text NOT NULL,
  name text NOT NULL,
  phone text,
  role text NOT NULL DEFAULT 'DRIVER'::text,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp without time zone NOT NULL DEFAULT now(),
  updated_at timestamp without time zone NOT NULL DEFAULT now(),
  department_id character varying,
  CONSTRAINT users_pkey PRIMARY KEY (id),
  CONSTRAINT users_department_id_departments_id_fk FOREIGN KEY (department_id) REFERENCES public.departments(id)
);
CREATE TABLE public.warehouse_containers (
  id character varying NOT NULL,
  location text NOT NULL,
  warehouse_zone text,
  qr_code text NOT NULL UNIQUE,
  material_type text NOT NULL,
  content_description text,
  current_amount real NOT NULL DEFAULT 0,
  max_capacity real NOT NULL,
  quantity_unit text NOT NULL DEFAULT 'kg'::text,
  status text NOT NULL DEFAULT 'AT_WAREHOUSE'::text,
  last_emptied timestamp without time zone,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp without time zone NOT NULL DEFAULT now(),
  updated_at timestamp without time zone NOT NULL DEFAULT now(),
  material_id character varying,
  is_full boolean NOT NULL DEFAULT false,
  is_blocked boolean NOT NULL DEFAULT false,
  notes text,
  CONSTRAINT warehouse_containers_pkey PRIMARY KEY (id),
  CONSTRAINT warehouse_containers_material_id_materials_id_fk FOREIGN KEY (material_id) REFERENCES public.materials(id)
);