Du bist Lead Engineer (Expo RN + NestJS + Postgres). Fixe mehrere Produktionsprobleme. Priorit√§t: Stabilit√§t & UX. Kein Pseudocode. Liefere vollst√§ndige Code-√Ñnderungen.

A) Karteneditor: UI-Layout √ºberlappt/verschwindet + Marker l√∂schen (Pflicht)
A1) Layout-Fix (Top Controls verschwinden)

Problem: Die obere Auswahl (Dropdown/Segment/Buttons) verschwindet unter anderem UI (√úberlappung).
Ursache ist typischerweise fehlende SafeArea, falsches zIndex, absolute positioning oder fehlendes paddingTop.

Fix (zwingend):

Screen Root als SafeAreaView (react-native-safe-area-context).

Top Controls in eigener Sticky-Header-Container:

position: 'relative' (kein absolute)

zIndex: 10

paddingTop: insets.top + 8

backgroundColor gesetzt (damit es nicht transparent √ºber der Map liegt)

Map Bereich nimmt Restfl√§che:

flex: 1

Wenn Scroll n√∂tig: Top Controls bleiben sichtbar (sticky), Map darunter.

Akzeptanz: Auf iPhone mit Notch und kleinen Androids sind die Top Controls immer sichtbar, nicht √ºberlappt, nicht abgeschnitten.

A2) Marker l√∂schen (Pflicht)

Es muss m√∂glich sein, gesetzte Marker anzuklicken und zu l√∂schen.

Definition:

L√∂schen entfernt nur die Position (x/y), nicht die Entit√§t.

Best√§tigungsdialog: ‚ÄûMarker wirklich l√∂schen? Entit√§t bleibt bestehen.‚Äú

UI:

Marker sind tappable.

Tap √∂ffnet BottomSheet/Popover:

‚ÄûVerschieben‚Äú (setzt Edit-Mode)

‚ÄûL√∂schen‚Äú (Confirm)

Zus√§tzlich: In der linken Liste (Stationen/Hallen) muss bei gesetztem Marker ein ‚ÄûTrash/Delete‚Äú-Icon verf√ºgbar sein.

Backend:
Implementiere Endpoints:

DELETE /admin/map/halls/:id/marker

DELETE /admin/map/stations/:id/marker

DELETE /admin/map/stands/:id/marker (falls St√§nde gemappt werden)

Server:

entfernt Marker in location_meta / position_meta (x/y null oder Key entfernen)

schreibt activity_logs:

type='MAP', action='MARKER_DELETED', metadata {entityType, entityId, oldX, oldY}

Akzeptanz: Marker kann zuverl√§ssig gel√∂scht werden und verschwindet sofort in UI (optimistic update + refetch).

B) Aktivit√§tsanzeige: Navigation/√ñffnen aus Einstellungen fixen (Pflicht)

Problem: Aktivit√§t √∂ffnet sich zwar manchmal, aber nicht zuverl√§ssig aus den Einstellungen heraus (Navigation Hook/Route falsch oder Deep Link falsch).

Fix (zwingend):

Stelle sicher, dass es eine Route/Screen-ID f√ºr ‚ÄûActivity‚Äú gibt (z. B. AdminActivityScreen).

Einstellungen-Men√º navigiert exakt auf diese Route:

navigation.navigate('AdminActivity') (oder korrektes Stack-Nesting)

Pr√ºfe Navigator-Struktur:

Wenn Settings in einem anderen Stack liegt, nutze navigation.getParent() oder CommonActions.navigate korrekt.

Implementiere fallback:

Wenn Screen nicht gefunden: zeige Toast und logge Error (aber kein Crash).

Akzeptanz: ‚ÄûAktivit√§t‚Äú √∂ffnet immer, egal ob √ºber Admin-Tab oder √ºber Einstellungen.

C) Statistiken: Crash/Restart fixen (Pflicht, h√∂chste Stabilit√§tspriorit√§t)

Problem: Screen ‚ÄûStatistiken‚Äú verursacht App-Absturz/Neustart (typisch: OOM durch gro√üe Datenmengen, endlose Re-render Schleife, nicht virtualisierte Listen/Charts, unhandled promise rejection).

C1) Sofortma√ünahmen (zwingend)

Umh√ºlle Statistik-Screen mit Error Boundary:

Fehler darf nicht App killen, sondern zeigt ‚ÄûStatistik konnte nicht geladen werden‚Äú + Retry.

Implementiere ‚ÄûLoading / Empty / Error‚Äú States sauber.

Verhindere Render-Schleifen:

Keine setState in render

useEffect Dependencies pr√ºfen

Memoization (useMemo/useCallback) f√ºr abgeleitete Daten

C2) Backend/Query-Reduktion (zwingend)

Statistiken d√ºrfen nicht ‚Äûalle Events aller Zeiten‚Äú laden.

API muss paginiert/aggregiert liefern:

GET /analytics/summary?from=YYYY-MM-DD&to=YYYY-MM-DD

Default Range: letzte 7 Tage

Liefere nur aggregierte Kennzahlen:

counts, sums, avg durations

Top-N Listen (z. B. Top 10 Materialien)

Wenn Details gebraucht: separate Endpoint mit Pagination.

C3) UI-Performance (zwingend)

Tabellen/Listen: FlatList virtualisiert, keyExtractor korrekt.

Charts:

keine riesigen Datens√§tze in Chart-Props

downsampling oder serverseitige Buckets (daily buckets)

Keine Inline-Objekte/Styles in Map/Charts, die Re-renders triggern (StyleSheet + memo).

Akzeptanz: Statistik-Screen l√§dt stabil, kein Restart, auch bei gro√üem Datenbestand.

D) Allgemeines Logging & QA (Pflicht)

Logging f√ºr kritische Screens:

Activity open

Analytics fetch start/end + payload sizes

Map marker ops (set/move/delete)

Baue einen ‚ÄûDev Debug Mode‚Äú Flag (nur dev):

zeigt Payload sizes, Render counts (optional)

Teste auf:

iPhone SE / kleines Android

iPhone Notch

langsame Verbindung

Deliverables

Karteneditor Layout Fix + Marker Delete (UI+API+Audit)

Activity Navigation Fix (Settings ‚Üí Activity)

Statistics Crash Fix (ErrorBoundary + Aggregation API + UI perf)

README_FIXES.md mit kurzer Beschreibung der √Ñnderungen

Kein Pseudocode. Vollst√§ndige Implementierung.

Wenn du m√∂chtest, kann ich dir als Nachsatz noch ein kurzes SQL geben, um Statistik-Endpunkte performant zu machen (Indexes auf task_events.timestamp, tasks.status, tasks.material_id/stand_id, etc.). Das ist oft der entscheidende Punkt, damit Analytics nicht mehr crasht.

wenn ja bitte

Perfekt. Hier ist das konkrete, produktionsreife SQL-Paket, das du sofort ausf√ºhren kannst, um die Statistik-Crashes, langsamen Queries und App-Neustarts zu beheben.
Das ist exakt auf dein Schema (tasks, task_events, materials, stands, stations, warehouse_containers) zugeschnitten.

üî¥ ZIEL

Statistiken d√ºrfen nicht mehr die App crashen

Analytics m√ºssen schnell & aggregiert sein

Grundlage f√ºr:

Fahreranalyse

Materialstatistiken

Stations-/Stand-Auswertungen

Zeitreihen (7/30/90 Tage)